{% extends "dashboard.html" %}

{% block main %}

<div class="main-view-top">
    <style>
        /* Make the transactions area scrollable with a sticky header */
        #transactions-table{max-height:400px;overflow:auto;border-radius:8px}
        #transactions-table table{width:100%;border-collapse:collapse}
        #transactions-table thead th{position:sticky;top:0;background:rgba(255, 255, 255, 1);z-index:3;padding:0.75rem;text-align:left}
        #transactions-table tbody tr{border-bottom:1px solid rgba(255,255,255,0.03)}
        /* subtle alternate row shading */
        #transactions-table tbody tr:nth-child(even){background:rgba(255,255,255,0.01)}
    </style>
    <div class="dashboard-section">
        <h3>Payments Overview</h3>
         
    </div>
 
    <div class="payments-wrapper">
        <div class="card-grid">
            <div class="summary-card">
                <i class="fas fa-wallet"></i>
                <div>
                    <h4>{{total_spent}}</h4>
                    <p class="muted">Total Spent</p>
                    <br>
                 </div>
            </div>
            <div class="summary-card">
                <i class="fas fa-receipt"></i>
                <div>
                    <h4>{{held_payment}} <small>ETB</small></h4>
                    <p class="muted">Held Payment</p>
                </div>
            </div> 
            
            <div class="summary-card">
                <i class="fas fa-receipt"></i>
                <div>
                    <h4>{{sessions|length}} </h4>
                    <p class="muted">Booked Sessions</p>
                </div>
            </div>  
        </div>
 

        <div class="section">
            <div class="dashboard-section">
                <h3>Transaction History</h3>
                <div class="filter-bar">
                    <input type="text" placeholder="Search..." hx-get="/api/transactions" hx-trigger="keyup changed delay:300ms" hx-target="#transactions-table">
                    <select hx-get="/api/transactions" hx-trigger="change" hx-target="#transactions-table">
                        <option value="">All Status</option>
                        <option value="paid">Paid</option>
                        <option value="pending">Pending</option>
                        <option value="failed">Failed</option>
                    </select>
                </div>
            </div>
            <div class="section-body" id="transactions-table" hx-get="/api/transactions" hx-trigger="load">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Student</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody class=tbody>
                    {% for tran in transactions %}

                        <tr>
                            <td>{{tran.updated_at}}</td>
                            <td>{{tran.session.subject_name}}</td>
                            <td>{{tran.tutor}}</td>
                            <td>{{tran.amount}}</td>
                            <td><span class="status-badge status-{{tran.status}}">{{tran.status}}</span></td>
                            <td><a href="{{tran.refrence_id}}" ><button class="btn btn-outline btn-vsm">Invoice</button></a>
                            </td>
                        </tr>
                        
                    {% endfor %}
                    
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- Withdraw modal -->
<div id="withdraw-modal" class="modal" aria-hidden="true" style="display:none;position:fixed;inset:0;z-index:1000;">
    <div class="modal-overlay" style="position:absolute;inset:0;background:rgba(0,0,0,0.5);"></div>
    <div class="modal-panel" role="dialog" aria-modal="true" style="position:relative;max-width:480px;margin:6% auto;background:#fff;border-radius:8px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.2)">
        <button id="withdraw-close" aria-label="Close" style="position:absolute;right:12px;top:12px;background:none;border:0;font-size:18px">âœ•</button>
        <h3 style="margin-top:0">Request Withdrawal</h3>
        <div id="withdraw-feedback" style="margin-bottom:8px;color:#333;"></div>

        <form id="withdraw-form" action="{% url 'withdraw_request' %}" method="post">
            {% csrf_token %}

            <div class="form-row" style="margin-bottom:10px">
                <label for="withdraw-amount">Amount (ETB)</label>
                <input type="number" name="amount" id="withdraw-amount" step="0.01" min="1" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px">
            </div>

            <div style="display:flex;gap:8px;justify-content:flex-end">
                <button type="button" id="withdraw-cancel" class="btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Submit</button>
            </div>
        </form>
    </div>
</div>

<script>
// Small modal + AJAX submit helper for withdraw
;(function(){
    function getCookie(name) {
        let v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return v ? v.pop() : '';
    }

    const openBtn = document.getElementById('open-withdraw');
    const modal = document.getElementById('withdraw-modal');
    const overlay = modal && modal.querySelector('.modal-overlay');
    const closeBtn = document.getElementById('withdraw-close');
    const cancelBtn = document.getElementById('withdraw-cancel');
    const form = document.getElementById('withdraw-form');
    const feedback = document.getElementById('withdraw-feedback');

    function showModal(){ if(!modal) return; modal.style.display='block'; modal.setAttribute('aria-hidden','false'); const inp = modal.querySelector('input[name="amount"]'); if(inp) inp.focus(); }
    function hideModal(){ if(!modal) return; modal.style.display='none'; modal.setAttribute('aria-hidden','true'); feedback.innerText = ''; form.reset(); }

    if(openBtn) openBtn.addEventListener('click', function(e){ e.preventDefault(); showModal(); });
    if(closeBtn) closeBtn.addEventListener('click', function(){ hideModal(); });
    if(cancelBtn) cancelBtn.addEventListener('click', function(){ hideModal(); });
    if(overlay) overlay.addEventListener('click', function(){ hideModal(); });

    document.addEventListener('keydown', function(e){ if(e.key === 'Escape') hideModal(); });

    if(form){
        form.addEventListener('submit', async function(e){
            e.preventDefault();
            feedback.style.color = '#333';
            feedback.innerText = 'Submitting withdrawal...';

            const data = new URLSearchParams(new FormData(form));

            try{
                const res = await fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: data
                });

                const json = await res.json().catch(()=>({ok:false,message:'Invalid server response'}));

                if(res.ok && json.ok !== false){
                    feedback.style.color = 'green';
                    feedback.innerText = json.message || 'Withdrawal submitted';
                    // refresh page after short delay to show updated balances
                    setTimeout(()=> location.reload(), 1100);
                } else {
                    feedback.style.color = 'crimson';
                    feedback.innerText = json.error || json.message || 'Failed to submit withdrawal';
                }

            } catch(err){
                feedback.style.color = 'crimson';
                feedback.innerText = 'Network error: ' + (err.message || err);
            }
        });
    }
})();
</script>
{% endblock main %}