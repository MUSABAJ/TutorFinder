 

{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    {% include "includes/_head.html" %}
</head>
<style>
    .dashboard-main {
        display: block;

    }
</style>

<body>
    <!-- Navbar -->
    {% include "includes/_navbar.html" %}

    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar">
            {% include "includes/_sidebar.html" %}
        </aside>
        <!-- Main Content -->
        <div class="dashboard-main">
            <div id='wrap' class="main-view-top">

    <div class="inside-wrap">
           <div id='external-events'>
        <h4>Draggable Package slots</h4>

        <div id='external-events-list'>
            {% for pkg in packages%}
            <div class='fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event'>
                <div class='fc-event-main' data-name='{{pkg.name}}' data-duration='{{pkg.session_duration}}'>
                    Name : {{pkg.name}} <br>
                    Duration : {{pkg.session_duration}} Min <br>
                    Type : {{pkg.session_type}}</div>
            </div>
            {%endfor%}
        </div>

        <p>
            <input type='checkbox' id='drop-remove' />
            <label for='drop-remove'>remove after drop</label>
        </p>
    </div>

    <div id='calendar-wrap'>
        <div id='calendar'></div>
    </div>

    </div>
    <form method="post" id="availablity-form">
        {%csrf_token%}
        <input type="hidden" name='availablity_json' id="availablity-json">
        <button class="btn btn-primary"> Save Availability </button>
    </form>

</div>

<script>
    // initialize the package Events


    let availablity = '{{availablity__json | safe}}'


    availablity = JSON.parse(availablity)
    document.addEventListener('DOMContentLoaded', function () {

        var containerE1 = document.getElementById('external-events-list');
        new FullCalendar.Draggable(containerE1, {
            itemSelector: '.fc-event',

        });

        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'timeGridWeek,timeGridDay'
            },
            initialView: 'timeGridWeek',
            editable: true,
            allDaySlot: false,
            slotDuration: '00:30:00',
            navLinks: true, // can click day/week names to navigate views
            selectable: true,
            droppable: true,
            events: [
                ...availablity.map(slot => ({
                    title: 'Available',
                    start: slot.start,
                    end: slot.end,
                    backgroundColor: '#28a745',
                    borderColor: '#28a745',
                }))

            ]

            ,
            drop: async function (info) {
                // modern modal-based replacement for confirm/prompt
                const duration = info.draggedEl.childNodes[1].getAttribute('data-duration')
                const title = info.draggedEl.childNodes[1].getAttribute('data-name')
                const end = new Date(info.date.getTime() + (duration * 60000))

                // ask user if they want to repeat weekly using modal UI
                const repeatResp = await openModal({
                    message: 'Repeat this slot weekly?',
                    confirmText: 'Yes',
                    cancelText: 'No',
                    showInput: false
                });

                let weeks = 0;
                if (repeatResp.confirmed) {
                    const weeksResp = await openModal({
                        message: 'Repeat for how many weeks?',
                        confirmText: 'Repeat',
                        cancelText: 'Cancel',
                        showInput: true,
                        defaultValue: '4',
                        inputType: 'number'
                    });
                    weeks = parseInt(weeksResp.value) || 0;
                }

                calendar.addEvent({
                    title: title,
                    start: info.date,
                    end: end
                });
                for (let i = 1; i <= weeks; i++) {
                    const nextStart = new Date(info.date)
                    const nextEnd = new Date(end)

                    nextStart.setDate(nextStart.getDate() + (i * 7));
                    nextEnd.setDate(nextEnd.getDate() + (i * 7));
                    calendar.addEvent({
                        title: title,
                        start: nextStart,
                        end: nextEnd
                    });
                }

            }
            ,
            eventClick: async function (info) {
                const resp = await openModal({
                    message: 'Remove this slot?',
                    confirmText: 'Remove',
                    cancelText: 'Cancel',
                    showInput: false
                });
                if (resp.confirmed) info.event.remove();
            }
        });

        calendar.render();

        // subit all availablity events in collection
        document.getElementById('availablity-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const events = calendar.getEvents().map(event => ({
                start: event.start.toISOString(),
                end: event.end.toISOString(),
                title: event.title
            }));

            document.getElementById('availablity-json').value = JSON.stringify(events);
            this.submit();
            window.alert()
        })
    });


</script>
<!-- Modal UI: simple modern modal used for confirmations and prompts -->
<div id="modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.6);backdrop-filter:blur(2px);z-index:9999;align-items:center;justify-content:center;padding:1rem">
    <div id="modal-dialog" style="background:#0b1220;color:#e6eef8;border-radius:12px;max-width:420px;width:100%;box-shadow:0 10px 40px rgba(2,6,23,0.6);overflow:hidden">
        <div style="padding:1rem 1rem 0.5rem;font-weight:700">Confirm</div>
        <div id="modal-message" style="padding:0 1rem 1rem;color:#9ca3af"></div>
        <div style="padding:0 1rem 1rem">
            <input id="modal-input" type="text" style="width:100%;padding:.5rem;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit;display:none">
        </div>
        <div style="display:flex;gap:.5rem;padding:0.75rem;border-top:1px solid rgba(255,255,255,0.02);justify-content:flex-end">
            <button id="modal-cancel" style="background:transparent;border:1px solid rgba(255,255,255,0.06);padding:.5rem 0.9rem;border-radius:8px;color:#cbd5e1">Cancel</button>
            <button id="modal-confirm" style="background:linear-gradient(90deg,#7c3aed,#4f46e5);border:none;padding:.5rem 0.9rem;border-radius:8px;color:white">OK</button>
        </div>
    </div>
</div>

<script>
    // modal helper returns Promise resolved with {confirmed: boolean, value: string|null}
    function openModal(options){
        options = options || {};
        const overlay = document.getElementById('modal-overlay');
        const dialog = document.getElementById('modal-dialog');
        const messageEl = document.getElementById('modal-message');
        const inputEl = document.getElementById('modal-input');
        const btnConfirm = document.getElementById('modal-confirm');
        const btnCancel = document.getElementById('modal-cancel');

        messageEl.textContent = options.message || '';
        inputEl.style.display = options.showInput ? 'block' : 'none';
        inputEl.value = options.defaultValue || '';
        inputEl.type = options.inputType || 'text';
        btnConfirm.textContent = options.confirmText || 'OK';
        btnCancel.textContent = options.cancelText || 'Cancel';

        overlay.style.display = 'flex';
        if(options.showInput) inputEl.focus();

        return new Promise(resolve => {
            function cleanup(){
                btnConfirm.removeEventListener('click', onConfirm);
                btnCancel.removeEventListener('click', onCancel);
                overlay.style.display = 'none';
            }
            function onConfirm(){
                const value = options.showInput ? inputEl.value : null;
                cleanup();
                resolve({confirmed:true, value: value});
            }
            function onCancel(){
                cleanup();
                resolve({confirmed:false, value: null});
            }
            btnConfirm.addEventListener('click', onConfirm);
            btnCancel.addEventListener('click', onCancel);
            // keyboard support
            function onKey(e){
                if(e.key === 'Escape') { onCancel(); }
                if(e.key === 'Enter' && options.showInput) { onConfirm(); }
            }
            document.addEventListener('keydown', onKey);
            // ensure listeners removed when finished
            const origResolve = resolve;
            resolve = function(val){
                document.removeEventListener('keydown', onKey);
                origResolve(val);
            }
        });
    }
</script>
<style>
    body {
        font-size: 14px;
        font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
    }
    .inside-wrap{
        display: flex;

    }
    #availablity-form{
        position: fixed;
        bottom:2rem ;
        margin-left: 8px;
    }
    #external-events {
        position: relative;
         width: 250px;
        padding: 10px 10px;
        border: 1px solid var(--surface-border);
    background: var(--surface-color);
        text-align: left;
        color: rgb(4, 117, 79);
        border-radius: .8rem;
    }

    #external-events h4 {
        padding: 0.52rem;
        font-size: 16px;
        margin-top: 0;
        margin-bottom: 10px;
        text-align: center;
        border-radius: .5rem;
        border-bottom: 1px solid rgb(92, 202, 180);
     }
     .fc-event
      {
        margin-top: 5px;
        padding: 0.3rem;
        background: rgb(11, 174, 155);
        font-weight: 600;
     }

    #external-events .fc-event {
        margin: 3px 0;
        cursor: move;
    }

    #external-events p {
        margin: 1.5em 0;
        font-size: 11px;
        color: #666;
    }

    #external-events p input {
        margin: 0;
        vertical-align: middle;
    }
    #wrap{
        width: 100%;
    }
    #calendar-wrap {
        flex: 1;
     }

    #calendar {
        max-width: 1100px;
        margin: 0 auto;
    }
</style>
        </div>
    </div>



    {% include "includes/_scripts.html" %}
</body>

</html>