



<div id='wrap'>

  <div id='external-events'>
    <h4>Draggable Events</h4>

    <div id='external-events-list'>
      {% for pkg in packages%}     
      <div class='fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event'>
        <div class='fc-event-main' data-name='{{pkg.name}}' data-duration='{{pkg.session_duration}}' >
                                  Name: {{pkg.name}} <br> 
                                  Duration: {{pkg.session_duration}} Min <br>
                                  Type: {{pkg.session_type}}</div>
      </div>
      {%endfor%}
    </div>

    <p>
      <input type='checkbox' id='drop-remove' />
      <label for='drop-remove'>remove after drop</label>
    </p>
  </div>

  <div id='calendar-wrap'>
    <div id='calendar'></div>
  </div>

</div>

  <form method="post" id="availablity-form">
  {%csrf_token%}
    <input type="hidden" name='availablity_json' id="availablity-json">
    <button> Save Availability </button>
</form>


<script>
  // initialize the package Events
 

  let availablity='{{availablity__json | safe}}'
  

  availablity = JSON.parse(availablity)
  document.addEventListener('DOMContentLoaded', function() {

 var containerE1 = document.getElementById('external-events-list');
  new FullCalendar.Draggable(containerE1,{
    itemSelector: '.fc-event',
     
  });

  var calendarEl = document.getElementById('calendar');

  var calendar = new FullCalendar.Calendar(calendarEl, {
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'timeGridWeek,timeGridDay'
    } ,
    initialView: 'timeGridWeek',
    editable: true,
    allDaySlot: false,
    slotDuration: '00:30:00',
    navLinks: true, // can click day/week names to navigate views
    selectable: true,
    droppable: true, 
        events:[
          ...availablity.map(slot=>({
          title: 'Available',
          start: slot.start,          
          end: slot.end,
          backgroundColor:'#28a745',
          borderColor:'#28a745',
        }))

      ]
      
      ,
      drop:function(info){
        const duration = info.draggedEl.childNodes[1].getAttribute('data-duration')
        const title = info.draggedEl.childNodes[1].getAttribute('data-name')
        const repeat = confirm('Reepeat this weekely?')
        const end = new Date(info.date.getTime()+(duration * 60000))
        let weeks = 0; 
        if (repeat){
          weeks = parseInt(prompt('Repeat for how many weeks??','4'))||0;
        }
        calendar.addEvent({
          title: title,
          start: info.date,
          end: end
        });
        for (let i =1;i<=weeks; i++){
          const nextStart = new Date(info.date)
          const nextEnd = new Date(end)

          nextStart.setDate(nextStart.getDate() + (i * 7));
          nextEnd.setDate(nextEnd.getDate() + (i * 7));
          calendar.addEvent({
          title: title,
          start: nextStart,
          end: nextEnd
        });
        }

      
      }
    //   ,
    // select: function(info){
    //   const title = prompt('Label this slot (optional)?', 'Available')
    //   if (title !== null){
    //     const repeat = confirm('Reepeat this weekely?')
    //     let weeks = 0;
    //     if (repeat){
    //       weeks = parseInt(prompt('Repeat for how many weeks??','4'))||0;
    //     }
    //     calendar.addEvent({
    //       title: title,
    //       start: info.start,
    //       end: info.end
    //     });
    //     for (let i =1;i<=weeks; i++){
    //       const nextStart = new Date(info.start)
    //       const nextEnd = new Date(info.end)

    //       nextStart.setDate(nextStart.getDate() + (i * 7));
    //       nextEnd.setDate(nextEnd.getDate() + (i * 7));
    //       calendar.addEvent({
    //     title: title,
    //     start: nextStart,
    //     end: nextEnd
    //   })
    //     }
      
    //   }
    // },
    ,
    eventClick: function(info){
      if (confirm('Remove this Slot?')){
        info.event.remove();
      }
    }
  });

  calendar.render();

  // subit all availablity events in collection
  document.getElementById('availablity-form').addEventListener('submit', function(e){
    e.preventDefault();

    const events = calendar.getEvents().map(event =>({
      start: event.start.toISOString(),
      end: event.end.toISOString(),
      title: event.title
    }));

    document.getElementById('availablity-json').value = JSON.stringify(events);
    this.submit();
    window.alert()
  })
});


</script>
<style>

  body {
    margin-top: 40px;
    font-size: 14px;
    font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
  }

  #external-events {
    position: fixed;
    left: 20px;
    top: 20px;
    width: 150px;
    padding: 0 10px;
    border: 1px solid #ccc;
    background: #eee;
    text-align: left;
  }

  #external-events h4 {
    font-size: 16px;
    margin-top: 0;
    padding-top: 1em;
  }

  #external-events .fc-event {
    margin: 3px 0;
    cursor: move;
  }

  #external-events p {
    margin: 1.5em 0;
    font-size: 11px;
    color: #666;
  }

  #external-events p input {
    margin: 0;
    vertical-align: middle;
  }

  #calendar-wrap {
    margin-left: 200px;
  }

  #calendar {
    max-width: 1100px;
    margin: 0 auto;
  }

</style>