{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    {% include "includes/_head.html" %}
</head>
<style>
    .dashboard-main {
        display: block;

    }
</style>

<body>
    <!-- Navbar -->
    {% include "includes/_navbar.html" %}

    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar">
            {% include "includes/_sidebar.html" %}
        </aside>
        <!-- Main Content -->
        <main class="dashboard-main">
            <div class="main-view">
                <div class="main-view-top">

                    <div class="profile-content">
                        <div class="profile-tabs">
                            <button class="tab-btn active" value="profile" onclick="showProfileTab('personal')">Personal
                                Info</button>
                            <button class="tab-btn" value="tutor" onclick="showProfileTab('tutor')">
                                {% if request.user.role == 'tutor' %} Tutor {% else %}Student {% endif %}
                                Details</button>
                            <button class="tab-btn" value="settings"
                                onclick="showProfileTab('settings')">Settings</button>
                        </div>

                        <div class="profile-main">

                            <div id="personal" class="tab-content active">
                                <div class="card ">



                                    <div class="profile-card">
                                        <div class="profile-avatar-large"><img src="/static{{user.avatar.url}}" alt="">
                                                <a onclick="openAvatarModal()" class="change_avatar"><i class="fas fa-pen" ></i></a>

                                        </div>

                                        <div>
                                            <h1>{{user.first_name}} {{user.last_name}}</h1>
                                            {% if request.user.role == 'tutor' %}
                                            <p>{{tutor.subjects }} Tutor</p>
                                            {% else %}
                                            <p>{{student.field_of_study }} </p>
                                            {% endif %}

                                        </div>
                                        <div style="   position: absolute; right: 2rem;">
                                            {% if not user.telegram_id %}<a href="https://t.me/yameteKudasiBot?start={{ user.id }}" class="btn btn-primary">
                                                ðŸ”— Link to your Telegram
                                            </a>{% endif %}
                                        </div> 
                                    </div>                                    <div class="card-header">
                                        <h3>Personal Information</h3>
                                    </div>
                                    <form class="profile-form" method="post" enctype="multipart/form-data">
                                        {% csrf_token%} 
                                        <div class="form-row">

                                            <div class="form-group">
                                                <label>First Name</label>
                                                {{user_form.first_name}}
                                            </div>
                                            <div class="form-group">
                                                <label>Last Name</label>
                                                {{user_form.last_name}}
                                            </div>

                                        </div>
                                        <div class="address-row">
                                            <div class="form-group">
                                                <label>Email</label>
                                                {{user_form.email}}
                                            </div>

                                            <div class="form-group">
                                                <label>Username</label>
                                                {{user_form.username}}
                                            </div>
                                            <div class="form-group">
                                                <label>Phone</label>
                                                {{user_form.phone}}
                                            </div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label>Date of Birth</label>
                                                {{user_form.date_of_birth}}
                                            </div>
                                            <div class="form-group">
                                                <label>Sex</label>
                                                {{user_form.gender }}
                                            </div>
                                        </div>
                                        <div class="address-row">
                                            <div class="form-group">
                                                <label>Country</label>
                                                {{user_form.country}}
                                            </div>
                                            <div class="form-group">
                                                <label>City</label>
                                                {{user_form.city}}
                                            </div>
                                            <div class="form-group">
                                                <label>Sub-City</label>
                                                {{user_form.sub_city}}
                                            </div>

                                        </div>
                                        <button type="submit" class=" btn btn-primary">Save</button>

                                        <!-- </form> -->
                                </div>
                            </div>

                            <div id="tutor" class="tab-content">
                                <div class="card-container">
                                    {%if request.user.role == 'tutor' %}

                                    <div class="card-header">
                                        <h3>Tutor Profile</h3>
                                     </div>
                                    <!-- <form class="profile-form" method="post">
                                        {% csrf_token%} -->
                                    <div class="form-group">
                                        <label>Bio</label>
                                        {{user_form.bio}}
                                    </div>
                                    <div class="form-group">
                                        <label>Subjects</label>
                                        {{tutor_form.subjects}}
                                    </div>
                                         <div class="input-group">
                                            <div class="form-group">
                                                <label>Experience (Years)</label>
                                                {{tutor_form.experience}}
                                            </div>
                                            <div class="form-group">
                                                <label>Hourly Rate</label>
                                                {{tutor_form.horuly_rate}}

                                            </div>
                                            <div class="form-group">
                                                <label>Teaching prefrence</label>
                                                {{tutor_form.teaching_prefrence}}

                                            </div>
                                        </div>
                                     <div class="form-row">
                                        <div class="file-form-group">
                                            <label>ID-Card </label>
                                            <div>
                                            {{tutor_form.id_card}}

                                            </div>
                                        </div>
                                        <div class="file-form-group">
                                            <label>Certificate File </label>
                                            <div>
                                            {{tutor_form.certificate_file}}

                                            </div>
                                            </div>
                                    </div>
                                     
                                    {% else %}
 
                                    <div class="card-header">
                                        <h3>Student Profile</h3>
                                    </div> 
                                    <div class="form-group">
                                        <label>Bio</label>
                                        {{user_form.bio}}
                                    </div>
                                    <div class="form-group">
                                        <label>Grade Level</label>
                                        {{student_form.grade_level}}
                                    </div>
                                    <div class="form-row">
                                        <div class="input-group">
                                            <div class="form-group">
                                                <label>Learning Goal</label>
                                                {{student_form.learning_goal}}
                                            </div>
                                            <div class="form-group">
                                                <label>Field of Study</label>
                                                {{student_form.field_of_study}}


                                            </div>
                                        </div>
                                    </div>

                                    {% endif %}
                                    <button type="submit" class=" btn btn-primary">Save</button>
                                    </form>
                                </div>
                            </div>

                            <div id="settings" class="tab-content">
                                <div class="card">
                                    {#<div class="card-header"><h3>Account Settings</h3></div>#}
                                    <form id="payment-form" class="profile-form"
                                          hx-post="{% url 'payment_info_form' %}"
                                          hx-target="body"
                                          hx-swap="outerHTML">
                                        {% csrf_token %}
                                        <div class="card-header">
                                            <h3>Payment Info</h3>
                                        </div>
                                            
                                        <div class="input-group">
                                            <div class="form-group">
                                                <label for="method_type">Payment Method</label>
                                                <select id="method_type" name="method_type" required>
                                                    <option value="">-- Choose method --</option>
                                                    <option value="card">Credit / Debit Card</option>
                                                    <option value="bank">Bank Account</option>
                                                    <option value="mobile">Mobile / Phone Money</option>
                                                </select>
                                            </div>

                                            <div class="form-group" id="bank-wrapper" style="display:none;">
                                                <label for="bank_code">Bank</label>

                                                <select id="bank_code" name="bank_code">
                                                    <option value="">-- Select bank --</option>

                                                <option value="3">sdf</option>
                                                    
                                                    {% for bank in bank_list.data %}

                                                <option value="{{ bank.id }}">{{ bank.name }}</option>
                                            {% endfor %}
                                                </select>
                                            </div>

                                            <div class="form-group" id="account-wrapper" style="display:none;">
                                                <label for="account_number">Account Number</label>
                                                <input id="account_number" name="account_number" type="text" placeholder="Account number">
                                            </div>

                                            <div class="form-group" id="card-wrapper" style="display:none;">
                                                <label for="card_number">Card Number</label>
                                                <input id="card_number" name="card_number" type="text" placeholder="1234 5678 9012 3456" inputmode="numeric" maxlength="19">
                                                <label for="card_name">Name on Card</label>
                                                <input id="card_name" name="card_name" type="text" placeholder="Cardholder name">
                                                <div style="display:flex;gap:.5rem;">
                                                    <input id="card_expiry" name="card_expiry" type="text" placeholder="MM/YY" maxlength="5" style="flex:1">
                                                    <input id="card_cvc" name="card_cvc" type="text" placeholder="CVC" maxlength="4" style="width:6rem">
                                                </div>
                                            </div>

                                            <div class="form-group" id="phone-wrapper" style="display:none;">
                                                <label for="phone_number">Phone Number (for mobile money)</label>
                                                <input id="phone_number" name="phone_number" type="tel" placeholder="+251 9xx xxx xxx">
                                                <label for="mobile_provider">Provider (optional)</label>
                                                <input id="mobile_provider" name="mobile_provider" type="text" placeholder="e.g. M-Pesa">
                                            </div>
                                        </div>

                                        <div style="margin-top:1rem;">
                                            <button type="submit" class="btn btn-primary">Save Payment Info</button>
                                        </div>
                                    </form>

                                    <script>
                                        (function(){
                                            const method = document.getElementById('method_type');
                                            const bankWrapper = document.getElementById('bank-wrapper');
                                            const accountWrapper = document.getElementById('account-wrapper');
                                            const cardWrapper = document.getElementById('card-wrapper');
                                            const phoneWrapper = document.getElementById('phone-wrapper');

                                            function updateVisibility() {
                                                const v = method.value;
                                                bankWrapper.style.display = v === 'bank' ? 'block' : 'none';
                                                accountWrapper.style.display = v === 'bank' ? 'block' : 'none';
                                                cardWrapper.style.display = v === 'card' ? 'block' : 'none';
                                                phoneWrapper.style.display = v === 'mobile' ? 'block' : 'none';

                                                // toggle required attributes
                                                document.getElementById('bank_code').required = v === 'bank';
                                                document.getElementById('account_number').required = v === 'bank';
                                                document.getElementById('card_number').required = v === 'card';
                                                document.getElementById('card_name').required = v === 'card';
                                                document.getElementById('card_expiry').required = v === 'card';
                                                document.getElementById('card_cvc').required = v === 'card';
                                                document.getElementById('phone_number').required = v === 'mobile';
                                            }

                                            method.addEventListener('change', updateVisibility);
                                            // initialize on load (for HTMX-replaced content)
                                            document.addEventListener('DOMContentLoaded', updateVisibility);
                                            // also run immediately in case DOMContentLoaded already fired
                                            updateVisibility();
                                        })();
                                    </script>
                                    <!-- <div class="card-header">
                                        <h3>Security</h3>
                                    </div>
                                    <div class="security-options">
                                        <div class="security-item">
                                            <div class="security-info">
                                                <h4>Change Password</h4>
                                                <p>Update your account password</p>
                                            </div>
                                            <button onclick="openP" class=" btn btn-outline">Change</button>
                                        </div>

                                        <div class="security-item">
                                            <div class="security-info">
                                                <h4>Delete Account</h4>
                                                <p>Permanently delete your account</p>
                                            </div>
                                            <button class="btn  btn-danger">Delete</button>
                                        </div>
                                    </div> -->
                                </div>


                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </main>
    </div>



    {% include "includes/_scripts.html" %}
    {%include 'includes/_avatar_form.html' %}
</body>

</html>